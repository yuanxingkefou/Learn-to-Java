#类加载机制

定义：虚拟机把描述类的数据从Class文件加载到内存，并对数据进行校验，转换解析和初始化，最终形成可以被虚拟机直接使用的Java类型

类的生命周期：加载，验证，准备，解析，初始化，使用和卸载。（验证，准备和解析统称为连接）

**有且只有五种情况必须立即对类进行初始化：**

* 1.遇到new,getstatic,putstatic,invokestatic这4条字节码指令时
* 2.使用java.lang.reflect包的方法对类进行反射调用时
* 3.当初始化一个类的时候，如果发现其父类还没有进行过初始化，则需要先触发其父类的初始化
* 4.当虚拟机启动时，用户指定一个要执行的主类，虚拟机会初始化这个主类
* 5.当使用JDK1.7的动态语言支持时，如果一个java.lang.invoke.MethodHandle实例最后的解析结果REF_getStatic,REF_putStatic,REF_invokeStatic的方法
    句柄，并且这个方法句柄所对应的类没有进行过初始化
    
这五种称为对类的主动引用

被动引用：

* 1.通过子类引用父类的静态字段，不会导致子类初始化
* 2.通过数组定义来引用类，不会触发此类的初始化
* 3.常量在编译阶段会存入调用类的常量池中，本质上并没有直接引用到定义常量的类，因此不会触发定义常量的类的初始化

接口的区别：第三种情况，当一个接口在初始化时，不要求其父接口全部都完成了初始化

**##类加载的过程**

**###加载（loading）**

* 1.通过一个类的全限定名来获取定义此类的二进制字节流
* 2.将这个字节流所代表的静态存储结构转化为方法区的运行时数据结构（一般包括静态变量，静态方法，常量池（包括类名，参数名，字符串常量等），类的源代码       等）
* 3.在堆中生成一个代表这个类的java.lang.Class对象，作为方法区这个类的各种数据的访问入口

**###验证（verification）**

目的：确保Class文件的字节流中包含的信息符合当前虚拟机的要求，并且不会危害虚拟机自身的安全

* 文件格式验证
* 元数据验证
* 字节码验证
* 符号引用验证

**###准备（preparation）**

正式为类变量分配内存并设置类变量初始值的阶段

**###解析（resolution）**

将常量池中的符号引用替换为直接引用的过程

**###初始化（initialization）**

执行类构造器`<clinit>()`方法的过程，类构造器方法是由编译器自动收集类中的所有类变量的赋值动作和静态语句块(static)中的语句合并产生的

**##类加载器**

把类加载阶段中的“通过一个类的全限定名来获取描述此类的二进制字节流”这个动作放到虚拟机外部去实现，实现这个动作的代码模块称为类加载器

* 启动类加载器（Bootstrap ClassLoader）
* 扩展类加载器（Extension ClassLoader）
* 应用程序类加载器（Application ClassLoader）

